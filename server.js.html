<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>server.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="",baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body class="dark" data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="XMWStU9bke_XHkYWR7Sv3"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="app.html">app</a></div><div class="sidebar-section-children"><a href="io.html">io</a></div><div class="sidebar-section-children"><a href="myPeer.html">myPeer</a></div><div class="sidebar-section-children"><a href="peerApp.html">peerApp</a></div><div class="sidebar-section-children"><a href="server.html">server</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="v0S_xoDaSogWHx7xI1r7d"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="app.html#event:get">get</a></div><div class="sidebar-section-children"><a href="app.html#event:get">get</a></div><div class="sidebar-section-children"><a href="app.html#event:get">get</a></div><div class="sidebar-section-children"><a href="app.html#event:set">set</a></div><div class="sidebar-section-children"><a href="app.html#event:use">use</a></div><div class="sidebar-section-children"><a href="app.html#event:use">use</a></div><div class="sidebar-section-children"><a href="app.html#event:use">use</a></div><div class="sidebar-section-children"><a href="camera.html#event:start">start</a></div><div class="sidebar-section-children"><a href="hands.html#event:onResults">onResults</a></div><div class="sidebar-section-children"><a href="hands.html#event:setOptions">setOptions</a></div><div class="sidebar-section-children"><a href="io.html#event:connect">connect</a></div><div class="sidebar-section-children"><a href="io.html#event:on">on</a></div><div class="sidebar-section-children"><a href="myPeer.html#event:on">on</a></div><div class="sidebar-section-children"><a href="myPeer.html#event:on">on</a></div><div class="sidebar-section-children"><a href="peerApp.html#event:use">use</a></div><div class="sidebar-section-children"><a href="global.html#peerServer#event:listen">listen</a></div><div class="sidebar-section-children"><a href="server.html#event:listen">listen</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="50xeZwaRJmzHVmNrgpUWe"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#addVideoStream">addVideoStream</a></div><div class="sidebar-section-children"><a href="global.html#breakoutUnbreakout">breakoutUnbreakout</a></div><div class="sidebar-section-children"><a href="global.html#connectToNewUser">connectToNewUser</a></div><div class="sidebar-section-children"><a href="global.html#cors">cors</a></div><div class="sidebar-section-children"><a href="global.html#currentPeer">currentPeer</a></div><div class="sidebar-section-children"><a href="global.html#detect_fingersup">detect_fingersup</a></div><div class="sidebar-section-children"><a href="global.html#express">express</a></div><div class="sidebar-section-children"><a href="global.html#ExpressPeerServer">ExpressPeerServer</a></div><div class="sidebar-section-children"><a href="global.html#findhandpos">findhandpos</a></div><div class="sidebar-section-children"><a href="global.html#Gesture">Gesture</a></div><div class="sidebar-section-children"><a href="global.html#gesturesEnabled">gesturesEnabled</a></div><div class="sidebar-section-children"><a href="global.html#isBreakout">isBreakout</a></div><div class="sidebar-section-children"><a href="global.html#muteUnmute">muteUnmute</a></div><div class="sidebar-section-children"><a href="global.html#myVideo">myVideo</a></div><div class="sidebar-section-children"><a href="global.html#myVideoStream">myVideoStream</a></div><div class="sidebar-section-children"><a href="global.html#onGestureAction">onGestureAction</a></div><div class="sidebar-section-children"><a href="global.html#onResults">onResults</a></div><div class="sidebar-section-children"><a href="global.html#participantBreakOutRoomMap">participantBreakOutRoomMap</a></div><div class="sidebar-section-children"><a href="global.html#peers">peers</a></div><div class="sidebar-section-children"><a href="global.html#peerServer">peerServer</a></div><div class="sidebar-section-children"><a href="global.html#playStop">playStop</a></div><div class="sidebar-section-children"><a href="global.html#RateLimit">RateLimit</a></div><div class="sidebar-section-children"><a href="global.html#roomHostsMap">roomHostsMap</a></div><div class="sidebar-section-children"><a href="global.html#roomParticipantsMap">roomParticipantsMap</a></div><div class="sidebar-section-children"><a href="global.html#screenSharing">screenSharing</a></div><div class="sidebar-section-children"><a href="global.html#screenStream">screenStream</a></div><div class="sidebar-section-children"><a href="global.html#scrollToBottom">scrollToBottom</a></div><div class="sidebar-section-children"><a href="global.html#setDisableGestures">setDisableGestures</a></div><div class="sidebar-section-children"><a href="global.html#setEnableGestures">setEnableGestures</a></div><div class="sidebar-section-children"><a href="global.html#setExitBreakoutRoom">setExitBreakoutRoom</a></div><div class="sidebar-section-children"><a href="global.html#setMuteButton">setMuteButton</a></div><div class="sidebar-section-children"><a href="global.html#setPlayVideo">setPlayVideo</a></div><div class="sidebar-section-children"><a href="global.html#setStopVideo">setStopVideo</a></div><div class="sidebar-section-children"><a href="global.html#setUnmuteButton">setUnmuteButton</a></div><div class="sidebar-section-children"><a href="global.html#startScreenShare">startScreenShare</a></div><div class="sidebar-section-children"><a href="global.html#stopScreenSharing">stopScreenSharing</a></div><div class="sidebar-section-children"><a href="global.html#toggleChat">toggleChat</a></div><div class="sidebar-section-children"><a href="global.html#toggleGesture">toggleGesture</a></div><div class="sidebar-section-children"><a href="global.html#videoGrid">videoGrid</a></div><div class="sidebar-section-children"><a href="global.html#.onchange">.onchange</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">server.js</h1></header><article><pre class="prettyprint source lang-js"><code>/*
 * Copyright (C) 2022 Kraft, Royapally, Sarthi, Ramaswamy, Maduru, Harde, Gomes, Bellam, Reddy, Craine, Gupta - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the MIT license that can be found in the LICENSE file or
 * at https://opensource.org/licenses/MIT.
 * You should have received a copy of the MIT license with
 * this file. If not, please write to: develop.nak@gmail.com, or visit https://github.com/SiddarthR56/spark/blob/main/README.md.
 */

/**
 * Logic for setting and starting up the server, setting recognized routes, and
 * setting which server-side socket signals to respond to with server-side functionality.
 *
 * @requires express
 * @requires cors
 * @requires socket.io
 * @requires peer
 * @requires uuid
 * @requires express-rate-limit
 */

/**
 * Express module for starting route-based apps.
 *
 * @const
 */
const express = require('express');

/**
 * The app instance for serving webpage and routing data to any client.
 * Requires no params for instantiation in the context of the server
 * and its default settings.
 *
 * @type {Object}
 * @constructor
 * @fires app#use
 * @fires app#set
 * @fires app#get
 * @fires app#on
 */
const app = express();

/**
 * Module for cross-origin resource sharing; needed so that the protocol default CORS
 * policy can be overridden.
 *
 * @const
 */
const cors = require('cors');

/**
 * The HTTP server module used for starting Spark's server to serve webpage content.
 *
 * @type {Object}
 * @param {Object} [app] Reference to instantiated express app that server module can interface on
 * @const
 * @constructor
 *
 * @listen server#listen
 */
const server = require('http').Server(app);

/**
 * The socket module that allows for peer-to-peer connection support.
 *
 * @type {Object}
 * @const
 * @param {Object} [server] Reference to the HTTP server that will be used to listen for new connections
 * @param {Object} [config] Settings for the socket connection; used for setting CORS origin for connection
 * @constructor
 *
 * @fires io#on
 */
const io = require('socket.io')(server, {
  cors: {
    origin: '*',
  },
});

/**
 * Module for peer.js that allows for express app support for peer-to-peer connections.
 *
 * @const
 */
const ExpressPeerServer = require('peer').ExpressPeerServer;

/**
 * The app instance for managing new multi-peer connections from clients using rooms.
 * Requires no params for instantiation in the context of the server
 * and its default settings.
 *
 * @const
 * @type {Object}
 * @constructor
 * @fires peerApp#use
 */
const peerApp = express();

/**
 * The HTTP server module used for starting Spark's server to listen for new peers and their activity; uses createServer
 * to set up the peer.js functionality.
 *
 * @type {Object}
 * @param {Object} [peerApp] Reference to instantiated peer.js express app that server module can interface on
 * @const
 * @method
 *
 * @listens peerServer#listen
 */
const peerServer = require('http').createServer(peerApp);
/**
 * Module for generating UUIDs, using v4 specifically to generate securely.
 *
 * @const
 */

const { v4: uuidV4 } = require('uuid');

/**
 * Module for enforcing rate limit on an express app
 *
 * @const
 */
const RateLimit = require('express-rate-limit');

/*
 **
 * Sets up the rate limit rules to be used for the express app
 *
 * @constructor
 * @param {Object} [configs] Settings used for the rate limiting rules
 */
const limiter = RateLimit({
  windowMs: 1 * 60 * 1000, // 1 minute
  max: 20,
});

/**
 * Variable to keep track of room hosts for determining host-only actions
 *
 * @type {Object}
 */
var roomHostsMap = {};
/**
 * Variable to keep track of room participants for determining host-only actions
 *
 * @type {Object}
 */
var roomParticipantsMap = {};
/**
 * Variable to keep track of breakout rooms for determining where to place participants.
 *
 * @type {Object}
 */
var participantBreakOutRoomMap = {};

/**
 * Sets various configs for the express app; in the context of Spark, it's only used to set
 * the view engine from HTML to EJS files.
 *
 * @event app#set
 */
app.set('view engine', 'ejs');
/**
 * Applies CORS for all requests.
 *
 * @event app#use
 */
app.use(cors());
/**
 * Tells the express app to reference any static files to serve under the
 * project's public directory.
 *
 * @event app#use
 */
app.use(express.static('public'));
/**
 * Tells the express app to reference the instantiated rate limiter rules.
 *
 * @event app#use
 */
app.use(limiter);
/**
 * Sets up a route to listen to peer connections with debug options.
 *
 * @event peerApp#use
 */
peerApp.use(
  '/peerjs',

  ExpressPeerServer(peerServer, { debug: true })
);

/**
 * GET / : redirects the user to a room with an ID generated by UUID v4
 *
 * @event app#get
 * @param {string} [path] The path for which the GET will act on
 * @param {function} [callback] The function with request and response pair that runs when the endpoint is hit
 */
app.get('/', (req, res) => {
  res.redirect(`/${uuidV4()}`);
});

/**
 * GET /:room : Parametrized room route that serves back the view/room.ejs file with the given room ID
 *
 * @event app#get
 * @param {string} [path] The path for which the GET will act on, parametrized with :
 * @param {function} [callback] The function with request and response pair that runs when the endpoint is hit
 */
app.get('/:room', (req, res) => {
  res.render('room', { roomId: req.params.room });

  // Initialize the creation of roomParticipantsMap and roomHostsMap
  if (!roomHostsMap[req.params.room]) {
    roomParticipantsMap[req.params.room] = [];
    roomHostsMap[req.params.room] = null;
  }
});
/**
 * GET /:room/close : Route that shuts down the server when hit
 *
 * @event app#get
 * @param {string} [path] The path for which the GET will act on, parametrized with :
 * @param {function} [callback] The function with request and response pair that runs when the endpoint is hit
 */

app.get('/:room/close', (req, res) => {
  server.close();
  peerServer.close();
  res.send('Http closed');
});
/**
 * Handles setting up initial server-side functions for new socket.io connections that it picks up.
 *
 * @method
 * @param {string} [label] Label of the signal that io picks up
 * @param {function} [callback] Function that acts on a connecting socket that is called when hit
 * @event io#on
 * @listens io#connect
 */

io.on('connection', (socket) => {
  /**
   * Handles when a client socket calls join-room.
   *
   * @param {string} [label] Label of the signal that io picks up
   * @param {function} [callback] Function that acts on a connecting socket that is called when hit
   * @listens socket#emit
   */
  socket.on(
    'join-room',
    /* istanbul ignore next */ (roomId, userId) => {
      /*
       * Note: This entire callback function will be ignored by nyc for purposes of unit testing
       * and coverage, since nyc can't keep track of the server-side functions given by the
       * socket.io server, and can only keep track of the client-side functions of the socket
       * defined in the tests.
       */

      // initialize roomParticipants for a room
      if (!roomParticipantsMap[roomId]) {
        roomParticipantsMap[roomId] = [];
      }

      // Make the socket join a channel under roomId that the io server will broadcast messages to
      socket.join(roomId);

      // First person to join the room is assumed to be the host
      if (roomHostsMap[roomId] === null) {
        roomHostsMap[roomId] = userId;
      }
      // Broadcast to all existing clients in the room that a user has connected
      socket.to(roomId).emit('user-connected', userId);

      // Add anyone who joins the room to the roomParticipantsMap
      roomParticipantsMap[roomId].push(userId);

      /**
       * Handles when a client socket sends a message signal.
       *
       * @param {string} [label] Label of the signal that io picks up
       * @param {function} [callback] Function that acts on a connecting socket that is called when hit
       * @listens socket#emit
       */

      socket.on('message', (message) => {
        // Send message to the same room
        io.to(roomId).emit('createMessage', message);
      });
      /**
       * Handles when a client socket sends a filetransfer signal.
       *
       * @param {string} [label] Label of the signal that io picks up
       * @param {function} [callback] Function that acts on a connecting socket that is called when hit
       * @listens socket#emit
       */
      socket.on('filetransfer', (blob) => {
        io.to(roomId).emit('downloadFile', blob);
      });
      /**
       * Handles when a client socket sends a mute-all signal.
       *
       * @param {string} [label] Label of the signal that io picks up
       * @param {function} [callback] Function that acts on a connecting socket that is called when hit
       * @listens socket#emit
       */
      socket.on('muteAllUsers', (userId, roomId) => {
        // Check if the provided userId is the ID of a host, and if it is, broadcast the muteAll
        if (roomHostsMap[roomId].includes(userId)) {
          io.to(roomId).emit('muteAll', userId);
        }
      });

      /**
       * Handles when a host socket sends a breakout-room signal.
       *
       * @param {string} [label] Label of the signal that io picks up
       * @param {function} [callback] Function that acts on a connecting socket that is called when hit
       * @listens socket#emit
       */
      socket.on('createBreakoutRooms', (userId, roomId, numRooms) => {
        // send peers into breakout rooms created by the host
        if (roomHostsMap[roomId].includes(userId)) {
          var newRoomIds = Array(numRooms);

          // create new room ids to send people
          for (let i = 0; i &lt; numRooms; i++) {
            newRoomIds[i] = `${uuidV4()}`;
          }

          // function call to create a map of which participant goes to which room
          participantBreakOutRoomMap = (function (
            roomHostsMap,
            roomParticipantsMap,
            currentRoom,
            numRooms,
            newRoomIds
          ) {
            var participantBreakOutRoomMap = {};

            // get host and remove host from participants
            const host_index = roomParticipantsMap[currentRoom].indexOf(roomHostsMap[currentRoom]);
            roomParticipantsMap[currentRoom].splice(host_index, 1);

            // get how many partcipants should usually be allocated
            var numParticipantsEach = roomParticipantsMap[currentRoom].length / numRooms;

            // initialize variables
            var numPartitipantsInEachRoom = [];
            numPartitipantsInEachRoom = Array(numRooms).fill(0);
            var numLoop = numRooms;

            // when number of peers in room is divisble by the number of rooms to create
            if (roomParticipantsMap[currentRoom].length % numRooms != 0) {
              while (numLoop != -1) {
                var pos = numLoop % numRooms;
                numPartitipantsInEachRoom[pos] += 1;
                numLoop -= 1;
              }
            } else {
              numPartitipantsInEachRoom = Array(numRooms).fill(numParticipantsEach);
            }

            // randomize the array to allocate peers randomly
            const shuffledParticipants = (function (array) {
              let currentIndex = array.length,
                randomIndex;

              // While there remain elements to shuffle.
              while (currentIndex != 0) {
                // Pick a remaining element.
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
              }

              return array;
            })(roomParticipantsMap[currentRoom]);

            // create a map of userId: newRoom
            var currIndex = 0;
            for (let i = 0; i &lt; numRooms; i++) {
              for (let j = 0; j &lt; numPartitipantsInEachRoom[i]; j++) {
                participantBreakOutRoomMap[shuffledParticipants[currIndex]] = newRoomIds[i];
                currIndex += 1;
              }
            }

            return participantBreakOutRoomMap;
          })(roomHostsMap, roomParticipantsMap, roomId, numRooms, newRoomIds);

          // broadcast to the peers in the room to join breakout room
          io.to(roomId).emit('joinBreakOutRoom', participantBreakOutRoomMap, roomHostsMap);
        }
      });

      /**
       * Handles when a host socket sends an exit breakout-room signal.
       *
       * @param {string} [label] Label of the signal that io picks up
       * @param {function} [callback] Function that acts on a connecting socket that is called when hit
       * @listens socket#emit
       */
      socket.on('exitBreakoutRooms', (userId, roomId) => {
        // disconnect users from their rooms
        if (roomHostsMap[roomId].includes(userId)) {
          const maps = [roomHostsMap, roomParticipantsMap];

          // broadcast peers to exit the room
          io.to(roomId).emit('exitBreakRoom', roomId, maps);

          // delete entries in breakout room map
          for (let eachUserId in participantBreakOutRoomMap) {
            delete participantBreakOutRoomMap[eachUserId];
          }
        }
      });

      /**
       * Handles when a client socket sends a disconnect signal.
       *
       * @param {string} [label] Label of the signal that io picks up
       * @param {function} [callback] Function that acts on a connecting socket that is called when hit
       * @listens socket#emit
       */
      socket.on('disconnect', () => {
        socket.to(roomId).emit('user-disconnected', userId);

        // remove participant from the room's map
        const index = roomParticipantsMap[roomId].indexOf(userId);
        roomParticipantsMap[roomId].splice(index, 1);

        // check if the user is exiting a break out room
        if (participantBreakOutRoomMap[userId]) {
          delete participantBreakOutRoomMap[userId];
        }
        // when a user is not in any breakout room
        else {
          // remove participant from the room's map
          const index = roomParticipantsMap[roomId].indexOf(userId);
          roomParticipantsMap[roomId].splice(index, 1);

          if (roomHostsMap[roomId]) {
            // if the user is host, then assign a random person in the participants as the host
            if (roomParticipantsMap[roomId].length > 0 &amp;&amp; roomHostsMap[roomId].includes(userId)) {
              const randomElement =
                roomParticipantsMap[roomId][Math.floor(Math.random() * roomParticipantsMap[roomId].length)];
              roomHostsMap[roomId] = randomElement;
            }
          }
        }
      });
    }
  );
});

/**
 * Makes the app server listen to requests to the given port
 *
 * @method
 * @param {number} [port] The port number to listen to requests from
 * @event server#listen
 */
server.listen(process.env.PORT || 3030);
/**
 * Makes the peer server listen to requests to the given port
 *
 * @method
 * @param {number} [port] The port number to listen to requests from
 * @event peerServer#listen
 */
peerServer.listen(process.env.PEER_PORT || 3001);

/* Needed for testing purposes */
module.exports = { app, io };
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Home</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="XMWStU9bke_XHkYWR7Sv3"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="app.html">app</a></div><div class="sidebar-section-children"><a href="io.html">io</a></div><div class="sidebar-section-children"><a href="myPeer.html">myPeer</a></div><div class="sidebar-section-children"><a href="peerApp.html">peerApp</a></div><div class="sidebar-section-children"><a href="server.html">server</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="v0S_xoDaSogWHx7xI1r7d"><div>Events</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="app.html#event:get">get</a></div><div class="sidebar-section-children"><a href="app.html#event:get">get</a></div><div class="sidebar-section-children"><a href="app.html#event:get">get</a></div><div class="sidebar-section-children"><a href="app.html#event:set">set</a></div><div class="sidebar-section-children"><a href="app.html#event:use">use</a></div><div class="sidebar-section-children"><a href="app.html#event:use">use</a></div><div class="sidebar-section-children"><a href="app.html#event:use">use</a></div><div class="sidebar-section-children"><a href="camera.html#event:start">start</a></div><div class="sidebar-section-children"><a href="hands.html#event:onResults">onResults</a></div><div class="sidebar-section-children"><a href="hands.html#event:setOptions">setOptions</a></div><div class="sidebar-section-children"><a href="io.html#event:connect">connect</a></div><div class="sidebar-section-children"><a href="io.html#event:on">on</a></div><div class="sidebar-section-children"><a href="myPeer.html#event:on">on</a></div><div class="sidebar-section-children"><a href="myPeer.html#event:on">on</a></div><div class="sidebar-section-children"><a href="peerApp.html#event:use">use</a></div><div class="sidebar-section-children"><a href="global.html#peerServer#event:listen">listen</a></div><div class="sidebar-section-children"><a href="server.html#event:listen">listen</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div><div class="sidebar-section-children"><a href="socket.html#event:on">on</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="50xeZwaRJmzHVmNrgpUWe"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#addVideoStream">addVideoStream</a></div><div class="sidebar-section-children"><a href="global.html#breakoutUnbreakout">breakoutUnbreakout</a></div><div class="sidebar-section-children"><a href="global.html#connectToNewUser">connectToNewUser</a></div><div class="sidebar-section-children"><a href="global.html#cors">cors</a></div><div class="sidebar-section-children"><a href="global.html#currentPeer">currentPeer</a></div><div class="sidebar-section-children"><a href="global.html#detect_fingersup">detect_fingersup</a></div><div class="sidebar-section-children"><a href="global.html#express">express</a></div><div class="sidebar-section-children"><a href="global.html#ExpressPeerServer">ExpressPeerServer</a></div><div class="sidebar-section-children"><a href="global.html#findhandpos">findhandpos</a></div><div class="sidebar-section-children"><a href="global.html#Gesture">Gesture</a></div><div class="sidebar-section-children"><a href="global.html#gesturesEnabled">gesturesEnabled</a></div><div class="sidebar-section-children"><a href="global.html#isBreakout">isBreakout</a></div><div class="sidebar-section-children"><a href="global.html#muteUnmute">muteUnmute</a></div><div class="sidebar-section-children"><a href="global.html#myVideo">myVideo</a></div><div class="sidebar-section-children"><a href="global.html#myVideoStream">myVideoStream</a></div><div class="sidebar-section-children"><a href="global.html#onGestureAction">onGestureAction</a></div><div class="sidebar-section-children"><a href="global.html#onResults">onResults</a></div><div class="sidebar-section-children"><a href="global.html#participantBreakOutRoomMap">participantBreakOutRoomMap</a></div><div class="sidebar-section-children"><a href="global.html#peers">peers</a></div><div class="sidebar-section-children"><a href="global.html#peerServer">peerServer</a></div><div class="sidebar-section-children"><a href="global.html#playStop">playStop</a></div><div class="sidebar-section-children"><a href="global.html#RateLimit">RateLimit</a></div><div class="sidebar-section-children"><a href="global.html#roomHostsMap">roomHostsMap</a></div><div class="sidebar-section-children"><a href="global.html#roomParticipantsMap">roomParticipantsMap</a></div><div class="sidebar-section-children"><a href="global.html#screenSharing">screenSharing</a></div><div class="sidebar-section-children"><a href="global.html#screenStream">screenStream</a></div><div class="sidebar-section-children"><a href="global.html#scrollToBottom">scrollToBottom</a></div><div class="sidebar-section-children"><a href="global.html#setDisableGestures">setDisableGestures</a></div><div class="sidebar-section-children"><a href="global.html#setEnableGestures">setEnableGestures</a></div><div class="sidebar-section-children"><a href="global.html#setExitBreakoutRoom">setExitBreakoutRoom</a></div><div class="sidebar-section-children"><a href="global.html#setMuteButton">setMuteButton</a></div><div class="sidebar-section-children"><a href="global.html#setPlayVideo">setPlayVideo</a></div><div class="sidebar-section-children"><a href="global.html#setStopVideo">setStopVideo</a></div><div class="sidebar-section-children"><a href="global.html#setUnmuteButton">setUnmuteButton</a></div><div class="sidebar-section-children"><a href="global.html#startScreenShare">startScreenShare</a></div><div class="sidebar-section-children"><a href="global.html#stopScreenSharing">stopScreenSharing</a></div><div class="sidebar-section-children"><a href="global.html#toggleChat">toggleChat</a></div><div class="sidebar-section-children"><a href="global.html#toggleGesture">toggleGesture</a></div><div class="sidebar-section-children"><a href="global.html#videoGrid">videoGrid</a></div><div class="sidebar-section-children"><a href="global.html#.onchange">.onchange</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>